name: Release Dry Run

# Manual trigger — builds everything without publishing
on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-app:
    uses: ./.github/workflows/_build-app.yml
    secrets: inherit

  build-sdk:
    uses: ./.github/workflows/_build-sdk.yml

  build-ui:
    uses: ./.github/workflows/_build-ui.yml

  verify:
    needs: [build-app, build-sdk, build-ui]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Verify artifacts
        run: |
          echo "## Release Dry Run — Artifact Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for dir in artifacts/nexus-*; do
            [ -d "$dir" ] || continue
            name=$(basename "$dir")
            echo "### $name" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            find "$dir" -type f -exec ls -lh {} \; >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          done

          if [ -d "artifacts/nexus-sdk" ]; then
            echo "### Nexus SDK" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            find "artifacts/nexus-sdk" -type f | head -20 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          if [ -d "artifacts/nexus-ui" ]; then
            echo "### Nexus UI" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            find "artifacts/nexus-ui" -type f | head -20 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          # Verify all expected platforms built
          EXPECTED="nexus-aarch64-apple-darwin nexus-x86_64-apple-darwin nexus-x86_64-unknown-linux-gnu nexus-x86_64-pc-windows-msvc"
          MISSING=""
          for platform in $EXPECTED; do
            if [ ! -d "artifacts/$platform" ]; then
              MISSING="$MISSING $platform"
            fi
          done

          if [ -n "$MISSING" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Missing platforms" >> $GITHUB_STEP_SUMMARY
            echo "The following platform builds failed:$MISSING" >> $GITHUB_STEP_SUMMARY
            echo "::error::Missing platform artifacts:$MISSING"
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All 4 platforms + SDK + UI built successfully." >> $GITHUB_STEP_SUMMARY
