# Nexus SDK (`@imdanibytes/nexus-sdk`)

TypeScript SDK for Nexus plugins. Two layers — generated HTTP client and hand-written convenience wrapper.

## File Ownership

### Generated (DO NOT EDIT)

Everything under `src/client/` is auto-generated by `@hey-api/openapi-ts` from the Host API OpenAPI spec. These files get overwritten on every `pnpm sdk` run.

```
src/client/
├── client.gen.ts    # HTTP client configuration
├── sdk.gen.ts       # Generated endpoint functions
├── types.gen.ts     # Generated request/response types
├── core/            # Runtime helpers (auth, interceptors)
└── index.ts         # Barrel re-export
```

**Regeneration pipeline** (run from repo root):

```bash
pnpm sdk
# 1. sdk:spec    — cargo test exports openapi.json from Rust
# 2. sdk:generate — openapi-ts regenerates src/client/
# 3. sdk:build   — tsc compiles to dist/
```

### Hand-written (OUR CODE)

`src/index.ts` is the L2 convenience wrapper. This is where we add:

- The `NexusPlugin` class (init, token refresh, typed method wrappers)
- `NexusHostEvent` type and `NexusEventHandler` callback type
- `onHostEvent()` — iframe postMessage listener for host system events
- Any future non-HTTP functionality (theming, lifecycle hooks, etc.)

This file is **not touched by code generation**. Safe to edit.

## Architecture

```
Plugin iframe
  └── NexusPlugin (src/index.ts)          ← hand-written L2
        ├── HTTP methods → client/ (generated)  ← talks to Host API :9600
        └── onHostEvent() → window.message      ← listens for postMessage from host
```

### Host → Plugin Communication

Two channels:

| Channel | When | Mechanism |
|---------|------|-----------|
| `NEXUS_LANGUAGE` env var | Container start | Docker env injection |
| `nexus:system` postMessage | Runtime | Host broadcasts to `iframe[data-nexus-plugin]` |

**Message protocol:**
```ts
{ type: "nexus:system", event: string, data: unknown }
```

**Current events:**
- `language_changed` — `{ language: string }` (BCP-47 code)

**Host-side broadcast:** `src/lib/pluginBridge.ts` → `broadcastToPlugins(event, data)`

## Adding a New System Event

1. Emit from the host frontend: `broadcastToPlugins("your_event", { ... })`
2. Document the event name and payload shape in this file
3. Plugin SDK consumers use: `nexus.onHostEvent((event, data) => { ... })`
