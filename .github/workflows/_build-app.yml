name: Build App (reusable)

on:
  workflow_call:
    inputs:
      version:
        description: "Version override (without v prefix). If empty, derived from git tag."
        required: false
        type: string
    secrets:
      APPLE_CERTIFICATE:
        required: false
      APPLE_CERTIFICATE_PASSWORD:
        required: false
      APPLE_ID:
        required: false
      APPLE_PASSWORD:
        required: false
      APPLE_TEAM_ID:
        required: false
      KEYCHAIN_PASSWORD:
        required: false
      TAURI_SIGNING_PRIVATE_KEY:
        required: true
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD:
        required: false

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
            os: macos
          - platform: macos-latest
            target: x86_64-apple-darwin
            os: macos
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            os: linux
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            os: windows

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: Sync version
        shell: bash
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          elif [[ "$GITHUB_REF_NAME" == v* ]]; then
            VERSION="${GITHUB_REF_NAME#v}"
          else
            echo "No version to sync — skipping"
            exit 0
          fi
          echo "Syncing version to $VERSION"

          # package.json (root)
          jq --arg v "$VERSION" '.version = $v' package.json > tmp.json && mv tmp.json package.json

          # tauri.conf.json
          jq --arg v "$VERSION" '.version = $v' src-tauri/tauri.conf.json > tmp.json && mv tmp.json src-tauri/tauri.conf.json

          # Cargo.toml — use a temp file for cross-platform compat
          awk -v ver="$VERSION" '/^version = "/{print "version = \""ver"\""; next} {print}' src-tauri/Cargo.toml > tmp.toml && mv tmp.toml src-tauri/Cargo.toml

      - name: Install Linux dependencies
        if: matrix.os == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Configure sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      - name: Set Rust compiler cache env
        shell: bash
        run: |
          echo "SCCACHE_GHA_ENABLED=true" >> $GITHUB_ENV
          # Test that sccache can start before setting it as RUSTC_WRAPPER.
          # If the GHA cache backend is down, build without caching instead of failing.
          if sccache --start-server 2>/dev/null; then
            sccache --stop-server 2>/dev/null || true
            echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV
            echo "sccache: enabled"
          else
            echo "::warning::sccache server failed to start — building without cache"
          fi

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build workspace packages
        run: pnpm --filter "@imdanibytes/nexus-ui" build

      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Install Tauri CLI
        run: cargo binstall tauri-cli --version "^2" --no-confirm

      # --- macOS code signing ---
      - name: Import Apple Developer Certificate
        if: matrix.os == 'macos'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain

      - name: Resolve signing identity
        if: matrix.os == 'macos'
        run: |
          CERT_INFO=$(security find-identity -v -p codesigning build.keychain | grep "Developer ID Application")
          CERT_ID=$(echo "$CERT_INFO" | awk -F'"' '{print $2}')
          echo "APPLE_SIGNING_IDENTITY=$CERT_ID" >> $GITHUB_ENV
          echo "Signing identity: $CERT_ID"

      # --- Build ---
      - name: Build Tauri app (macOS)
        if: matrix.os == 'macos'
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          CARGO_BUILD_TARGET: ${{ matrix.target }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ env.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: cargo tauri build --target ${{ matrix.target }}

      - name: Build Tauri app (Linux/Windows)
        if: matrix.os != 'macos'
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: cargo tauri build --target ${{ matrix.target }}

      - name: Show sccache stats
        shell: bash
        run: sccache --show-stats

      # --- Upload artifacts ---
      - name: Upload macOS artifacts
        if: matrix.os == 'macos'
        uses: actions/upload-artifact@v4
        with:
          name: nexus-${{ matrix.target }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app.tar.gz.sig

      - name: Upload Linux artifacts
        if: matrix.os == 'linux'
        uses: actions/upload-artifact@v4
        with:
          name: nexus-${{ matrix.target }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb
            src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage
            src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage.tar.gz
            src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage.tar.gz.sig

      - name: Upload Windows artifacts
        if: matrix.os == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: nexus-${{ matrix.target }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
            src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.nsis.zip
            src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.nsis.zip.sig
